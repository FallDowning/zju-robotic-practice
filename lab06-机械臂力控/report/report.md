## <center> 单关节力控制实验报告
### <center> 第三小组
### 实验要求
- 设计速度控制算法，控制一个机器人关节以恒定速度连续旋转，转速控制精度<2%；
- 设计力控制算法，在关节连续旋转过程中施加任意的阻力，关节能够实现柔顺适应；当阻力消失后，关节能够继续维持连续旋转；
- 在给定的参考代码基础上，调节控制器参数，观察力控制效果
### 实验原理与方法
实验提供的控制系统中，将期望的关节力矩$F_d$、环境受力$F_{ext}$及关节的期望速度vd与实际速度、加速度作为输入，对关节的速度进行了控制，使关节在施加阻力时适应效果相对柔顺，而没有对关节力矩进行控制。引入的导纳控制器的系统方程如下：
$$
   M(a) + D(v-v_d) = F_{ext} - F_d
$$
求解该微分方程可以得到：$v(t) = \frac{F_{ext}-G+Dv_d}{D} + \frac{DV_0-(F_{ext}-G)}{D}e^{-\frac{D}{M}t}$

其形式上近似于 $v = ke^{-at} + b$ ，具有类似质量-弹簧-阻尼系统的阻尼效果。其中α由M、D共同影响，k受D影响。M在时间尺度上影响系统响应，D在幅值大小及时间尺度上均有影响
### 实验结果与分析
在实验中，我们无法得知关节力矩的具体形式及参数，只能进行通过控制速度进行间接力控制，使系统具有类似于弹簧的阻尼效果，加速度连续因而关节力矩也柔顺
```bash
# 初始参数
dq_d = 1  # 目标速度
dq_r = 1  # 参考速度
servo_time = 0.02  # 控制周期
M = 10  # 惯量
D = 80  # 阻尼系数

# PID控制器参数
Kp = 170# 比例增益
Ki = 0.05  # 积分增益
Kd = 60 # 微分增益

# 初始化 PID 控制状态
integral_T = 0  # 积分误差
previous_T_error = 0  # 上一次的力矩误差

motor.send(1, dq_r)  # 发送初始速度

try:
    while True:
        # 获取电机反馈
        feedback = motor.feedback(1)
        q = feedback[0]  # 位置反馈
        dq = feedback[1]  # 速度反馈
        T = 0.465 * math.sin(q - 0.1) - feedback[2]  # 计算力矩误差

        # 打印反馈速度
        print("feedback vel:", dq)

        # 计算 PID 控制输出
        T_error = T  # 假设目标力矩为0，因此力矩误差就是 T
        integral_T += T_error * servo_time  # 累计积分误差
        derivative_T = (T_error - previous_T_error) / servo_time  # 计算微分误差

        # 计算 PID 输出
        PID_output = Kp * T_error + Ki * integral_T + Kd * derivative_T
        previous_T_error = T_error  # 更新上一次误差

        # 使用 PID 输出调整速度变化率
        ddq_r = (- D * (dq_r - dq_d) + PID_output) / M
        dq_r = dq_r + ddq_r * servo_time  # 更新参考速度
        motor.send(1, dq_r)  # 发送新的参考速度
        time.sleep(servo_time - 0.002)  # 等待下一个控制周期
```
在计算加速度时，我们采取PID算法来处理力矩，经过参数调整，选取KP = 170，KI = 0.05, KD = 60 取得的效果最佳，既能保证机械臂以指定速度匀速运动，受到外力时也非常柔顺。其中，调参的过程中发现，增大KP可以增加受到外力时机械臂的柔顺程度，但机械臂速度会变慢；增大KI有可能使机械臂无法做完整的圆周运动，因此应选取较小的KI，增大KD也会提升控制的柔顺程度，但太大会导致机械臂无法做完整的圆周运动。

实验给定代码中M、D的取值分别为10、80，已经具有了非常柔顺的控制效果。将M增大时，系统恢复原运动状态所需时间延长，类似于增大物体质量的效果，同时扳动机械臂将更加困难，与实验结果相符；将M减小则取得了相反的效果，同样符合预期。将D增大时，系统恢复原运动状态所需时间缩短，类似于增大弹簧阻尼的效果，实验结果亦如是；将D减小则取得了相反的效果
